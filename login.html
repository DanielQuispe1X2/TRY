<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkinGuard - Login Seguro</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body class="login-body">

  <!-- ðŸ”¹ Login -->
  <div class="login-container" id="loginBox">
    <img src="logo.png" alt="Logo SkinGuard" class="login-logo">
    <h2>Iniciar SesiÃ³n</h2>

    <form id="loginForm">
      <input type="email" id="email" placeholder="Correo electrÃ³nico" required>
      <input type="password" id="password" placeholder="ContraseÃ±a" required>
      <button type="submit" class="btn btn-primary">Iniciar SesiÃ³n</button>
    </form>

    <p style="margin-top:10px;">
      Â¿No tienes cuenta?
      <button id="showRegister" type="button" class="btn btn-secondary">Crear Cuenta</button>
    </p>

    <p id="loginError" class="hidden" style="color:red;margin-top:10px;">Credenciales incorrectas.</p>
  </div>

  <!-- ðŸ”¹ Registro -->
  <div class="login-container hidden" id="registerBox">
    <img src="logo.png" alt="Logo SkinGuard" class="login-logo">
    <h2>Registro de Usuario</h2>

    <form id="registerForm">
      <input type="email" id="regEmail" placeholder="Correo electrÃ³nico" required>
      <input type="text" id="regNombre" placeholder="Nombre completo (opcional)">
      <input type="password" id="regPassword" placeholder="ContraseÃ±a" required>
      <button type="submit" class="btn btn-primary">Registrarse</button>
    </form>

    <p style="margin-top:10px;">
      Â¿Ya tienes cuenta?
      <button id="showLogin" type="button" class="btn btn-secondary">Iniciar SesiÃ³n</button>
    </p>

    <p id="registerMsg" style="margin-top:10px;"></p>
  </div>

  <script>
    // ðŸ”— ConexiÃ³n a Supabase
    const SUPABASE_URL = "https://wstqsqgktlbdefugtpdv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzdHFzcWdrdGxiZGVmdWd0cGR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODUyNTQsImV4cCI6MjA3NDI2MTI1NH0.ArkLINOc0adJf8bFvf6W-HC-_kGucp15Lyw28ivmc1w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ðŸ” Hash de contraseÃ±as
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // ðŸ”„ Cambiar vistas
    const loginBox = document.getElementById("loginBox");
    const registerBox = document.getElementById("registerBox");
    document.getElementById("showRegister").addEventListener("click", () => {
      loginBox.classList.add("hidden");
      registerBox.classList.remove("hidden");
    });
    document.getElementById("showLogin").addEventListener("click", () => {
      registerBox.classList.add("hidden");
      loginBox.classList.remove("hidden");
    });

    // ðŸ§  Iniciar SesiÃ³n
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const hashed = await hashPassword(password);

      const { data, error } = await supabase
        .from("usuarios")
        .select("email, password, nombre")
        .eq("email", email)
        .maybeSingle();

      if (error) {
        console.error("Error Supabase:", error.message);
        document.getElementById("loginError").textContent = "Error al conectar con Supabase.";
        document.getElementById("loginError").classList.remove("hidden");
        return;
      }

      if (!data || data.password !== hashed) {
        document.getElementById("loginError").textContent = "Credenciales incorrectas.";
        document.getElementById("loginError").classList.remove("hidden");
        return;
      }

      // SesiÃ³n
      localStorage.setItem("isLoggedIn", "true");
      localStorage.setItem("userEmail", data.email);
      localStorage.setItem("userName", data.nombre || "");
      window.location.href = "index.html";
    });

    // ðŸ§¾ Registro
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      const nombre = document.getElementById("regNombre").value.trim();
      const hashed = await hashPassword(password);

      const msg = document.getElementById("registerMsg");
      msg.textContent = "Registrando usuario...";
      msg.style.color = "#555";

      const { data, error } = await supabase
        .from("usuarios")
        .insert([{ email, password: hashed, nombre }]);

      if (error) {
        console.error("Error al registrar:", error.message);
        msg.style.color = "red";
        msg.textContent = "Error al registrar: " + error.message;
      } else {
        msg.style.color = "green";
        msg.textContent = "âœ… Usuario registrado correctamente. Ahora puedes iniciar sesiÃ³n.";
        // Cambiar vista automÃ¡ticamente
        setTimeout(() => {
          registerBox.classList.add("hidden");
          loginBox.classList.remove("hidden");
          msg.textContent = "";
        }, 2000);
      }
    });
  </script>
</body>
</html>


