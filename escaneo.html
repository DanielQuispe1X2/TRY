<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SkinGuard ‚Ä¢ Escaneo</title>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background-color: #0f172a;
      color: #f8fafc;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 24px;
    }

    .scan-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px 28px;
      width: 100%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
    }

    .title-box {
      background: linear-gradient(90deg, rgba(43,183,166,0.25), rgba(46,158,246,0.25));
      border: 1px solid rgba(255,255,255,0.15);
      color: #ffffff;
      font-weight: 700;
      font-size: 1.3rem;
      border-radius: 12px;
      padding: 12px 18px;
      margin-bottom: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.5px;
    }
    .title-box span.icon { margin-right: 8px; font-size: 1.4rem; }

    .camera-container {
      position: relative;
      margin: 0 auto;
      width: min(224px, 80vw);
      aspect-ratio: 1 / 1;
      border-radius: 0px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(30, 41, 59, 0.6);
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    video, img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0px;
    }

    .tips {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 14px 16px;
      margin-top: 20px;
      width: 100%;
      font-size: 0.9rem;
      color: #cbd5e1;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      text-align: left;
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      margin-top: 14px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }

    .btn-primary {
      background: linear-gradient(90deg, #2563eb, #2bb7a6);
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .btn-primary:hover { background: linear-gradient(90deg, #1e40af, #249c8b); }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #f8fafc;
    }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }

    #photoPreview { display: none; }

    /* üîπ Tarjeta de estado (modelo) peque√±a arriba a la derecha */
    .status-indicator {
      position: fixed;
      top: 14px;
      right: 18px;
      background: rgba(255, 255, 255, 0.08);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
    }
    .status-loading { color: #facc15; }
    .status-ready { color: #22d3ee; }
    .status-error { color: #f87171; }

    /* üî∏ Overlay de an√°lisis */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(15,23,42,0.95);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
      color: #fff;
      text-align: center;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.1);
      border-top: 4px solid #22d3ee;
      border-radius: 50%;
      width: 60px; height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar {
      width: 200px; height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
      margin: 14px auto;
    }
    .progress-bar .fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg,#2563eb,#2bb7a6);
      animation: fillProgress 3s ease-in-out forwards;
    }
    @keyframes fillProgress { to { width: 100%; } }
  </style>
</head>

<body>
  <!-- Estado del modelo -->
  <div id="modelStatus" class="status-indicator status-loading">
    <span class="loading"></span> Cargando modelo...
  </div>

  <!-- Tarjeta principal -->
  <div class="scan-card">
    <div class="title-box">
      <span class="icon">üì∏</span> Capturar Imagen
    </div>

    <div class="camera-container">
      <video id="cameraFeed" autoplay playsinline></video>
      <img id="photoPreview" alt="Captura previa">
    </div>

    <div class="tips">
      <b>üí° Consejos para mejor resultado:</b><br>
      ‚Ä¢ Iluminaci√≥n natural uniforme üå§Ô∏è<br>
      ‚Ä¢ Centrar la lesi√≥n en el recuadro üéØ<br>
      ‚Ä¢ Mantener c√°mara estable ü§≥
    </div>

    <button id="captureBtn" class="btn btn-primary">üì∑ Capturar Lesi√≥n</button>
    <button id="uploadBtn" class="btn btn-secondary">‚¨ÜÔ∏è Subir desde Galer√≠a</button>
    <input type="file" id="galleryInput" accept="image/*" style="display:none" />
  </div>

  <!-- Overlay de an√°lisis -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <h2>Analizando Imagen</h2>
    <p>Nuestro modelo de IA est√° procesando la imagen...</p>
    <div class="progress-bar"><div class="fill"></div></div>
  </div>

  <script>
    /* ===============================
       CONFIGURACI√ìN INICIAL
    ================================ */
    let model;
    let isModelLoaded = false;

    const SUPABASE_URL = "https://wstqsqgktlbdefugtpdv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzdHFzcWdrdGxiZGVmdWd0cGR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODUyNTQsImV4cCI6MjA3NDI2MTI1NH0.ArkLINOc0adJf8bFvf6W-HC-_kGucp15Lyw28ivmc1w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const video = document.getElementById("cameraFeed");
    const photoPreview = document.getElementById("photoPreview");
    const captureBtn = document.getElementById("captureBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const galleryInput = document.getElementById("galleryInput");
    const statusEl = document.getElementById("modelStatus");
    const overlay = document.getElementById("loadingOverlay");

    /* ===============================
       CARGA DEL MODELO
    ================================ */
    async function loadModel() {
      try {
        updateStatus("Cargando modelo...", "loading");
        model = await tf.loadGraphModel("model.json");
        isModelLoaded = true;
        updateStatus("Modelo listo ‚úÖ", "ready");
      } catch (error) {
        console.error("Error al cargar el modelo:", error);
        updateStatus("Error al cargar modelo", "error");
      }
    }

    function updateStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = `status-indicator status-${type}`;
    }

    /* ===============================
       C√ÅMARA Y SUBIDA
    ================================ */
    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
      } catch (err) {
        alert("No se pudo acceder a la c√°mara. Verifica permisos.");
      }
    }

    captureBtn.addEventListener("click", () => {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = canvas.toDataURL("image/png");

      photoPreview.src = imageData;
      photoPreview.style.display = "block";
      video.style.display = "none";

      captureBtn.textContent = "üîç Analizar Lesi√≥n";
      captureBtn.onclick = () => processImageFromData(imageData);
    });

    // ‚úÖ Subir desde galer√≠a (versi√≥n corregida)
function openGallery() {
  galleryInput.click();
}
uploadBtn.addEventListener("click", openGallery);

galleryInput.addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      photoPreview.src = e.target.result;
      photoPreview.style.display = "block";
      video.style.display = "none";

      captureBtn.textContent = "üîÑ Volver a C√°mara";
      captureBtn.onclick = () => location.reload();

      // üîπ Eliminar el listener anterior para que NO vuelva a abrir el explorador
      uploadBtn.removeEventListener("click", openGallery);

      // üîπ Reasignar nueva funci√≥n: analizar
      uploadBtn.textContent = "üîç Analizar Lesi√≥n";
      uploadBtn.onclick = () => processImageFromData(e.target.result);
    };
    reader.readAsDataURL(file);
  }
});



    /* ===============================
       FUNCI√ìN DE PREDICCI√ìN
    ================================ */
    async function processImageFromData(base64Data) {
      if (!isModelLoaded) {
        alert("El modelo a√∫n se est√° cargando.");
        return;
      }

      const img = new Image();
      img.src = base64Data;
      await img.decode();

      try {
        const tensor = tf.browser.fromPixels(img)
          .resizeNearestNeighbor([224, 224])
          .toFloat()
          .div(255.0)
          .expandDims(0);

        const prediction = await model.predict(tensor);
        const data = await prediction.data();
        const confidence = data[1];
        const isMalignant = confidence > 0.5;
        const result = isMalignant ? "Maligno" : "Benigno";
        const displayConfidence = (isMalignant ? confidence : 1 - confidence) * 100;

        console.log(`üß† Resultado: ${result} | Confianza: ${displayConfidence.toFixed(2)}%`);

        // Actualizar en Supabase
        const userEmail = localStorage.getItem("userEmail");
        const { data: user, error } = await supabase
          .from("usuarios")
          .select("*")
          .eq("email", userEmail)
          .maybeSingle();

        if (!error && user) {
          await supabase
            .from("usuarios")
            .update({
              ultimo_resultado: result,
              ultima_confianza: displayConfidence
            })
            .eq("id", user.id);
        }

        // Mostrar overlay y redirigir
        overlay.style.display = "flex";
        setTimeout(() => {
          overlay.style.display = "none";
          window.location.href = "resultado.html";
        }, 3500);

      } catch (err) {
        console.error("Error durante la predicci√≥n:", err);
        alert("Ocurri√≥ un error al analizar la imagen.");
      }
    }

    window.onload = function() {
      loadModel();
      initCamera();
    };
  </script>
</body>
</html>
