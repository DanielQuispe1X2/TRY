<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard UV - SkinGuard</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Tarjeta UV (mantiene look SkinGuard) */
    .uv-card{background:linear-gradient(135deg,#fff 0%,#f8fafc 100%);border-radius:20px;box-shadow:0 6px 20px rgba(0,0,0,.1);padding:30px;max-width:680px;margin:30px auto;text-align:center}
    .uv-header{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(90deg,#e73c7e,#23a6d5);color:#fff;padding:15px 20px;border-radius:15px;font-weight:600}
    .uv-badge{background:rgba(255,255,255,.2);padding:6px 14px;border-radius:20px}
    .uv-body{margin-top:18px}
    .uv-level{height:14px;border-radius:8px;background:linear-gradient(90deg,#1ad37a,#ffe14a,#ff914d,#ff3b30,#8b00ff);position:relative;overflow:hidden}
    .uv-indicator{position:absolute;top:-4px;width:10px;height:22px;background:#2d3748;border-radius:3px;transition:left .45s ease}
    .uv-scale{display:flex;justify-content:space-between;font-size:.9rem;margin-top:12px;color:#555}
    .uv-warning{margin-top:12px;font-weight:700}
    .meta{margin-top:14px;color:#666;font-size:.92rem}
    .pill{display:inline-block;margin:6px 4px;padding:6px 10px;border-radius:999px;background:#edf2f7;color:#2d3748;font-size:.85rem}
  </style>
</head>
<body class="login-body">
  <div class="login-container">
    <h2>üìä Dashboard de SkinGuard</h2>
    <p id="status">Obteniendo tu ubicaci√≥n‚Ä¶</p>

    <div id="uvCard" class="uv-card hidden">
      <div class="uv-header">
        <div>√çndice UV ‚Äì <span id="cityName">‚Äî</span></div>
        <div class="uv-badge" id="uvValue">UV ‚Äî</div>
      </div>

      <div class="uv-body">
        <p id="uvStatus">Nivel de exposici√≥n: <strong>‚Äî</strong></p>

        <div class="uv-level">
          <div id="uvIndicator" class="uv-indicator" style="left:0%"></div>
        </div>

        <div class="uv-scale">
          <span>Bajo (1‚Äì2)</span><span>Moderado (3‚Äì5)</span><span>Alto (6‚Äì7)</span>
          <span>Muy alto (8‚Äì10)</span><span>Extremo (11+)</span>
        </div>

        <p id="uvAdvice" class="uv-warning">‚Äî</p>

        <div id="fitz" style="margin-top:6px"></div>

        <div class="meta" id="uvMeta">‚Äî</div>
      </div>
    </div>

    <button id="btnVolver" class="btn btn-secondary" style="margin-top:20px;width:100%">‚¨ÖÔ∏è Volver al Inicio</button>
  </div>

  <script>
    // ‚ö†Ô∏è API Key OpenUV proporcionada
    const OPENUV_KEY = "openuv-5d1bjjrmhrfa0nx-io";

    const statusEl = document.getElementById("status");
    const uvCard   = document.getElementById("uvCard");
    const cityName = document.getElementById("cityName");
    const uvValue  = document.getElementById("uvValue");
    const uvStatus = document.getElementById("uvStatus");
    const uvAdvice = document.getElementById("uvAdvice");
    const uvMeta   = document.getElementById("uvMeta");
    const uvInd    = document.getElementById("uvIndicator");
    const fitzBox  = document.getElementById("fitz");

    document.getElementById("btnVolver").addEventListener("click",()=>window.location.href="index.html");

    // Paso 1: geolocalizaci√≥n (lat, lon, alt)
    if (!navigator.geolocation){
      statusEl.textContent="‚ùå Tu navegador no soporta geolocalizaci√≥n.";
    }else{
      navigator.geolocation.getCurrentPosition(onGeoOK, onGeoErr, {enableHighAccuracy:true,timeout:15000,maximumAge:0});
    }

    async function onGeoOK(pos){
      const lat = +pos.coords.latitude.toFixed(6);
      const lng = +pos.coords.longitude.toFixed(6);
      // altitud puede venir null; si no viene, usamos 0
      const alt = (pos.coords.altitude!=null && !Number.isNaN(pos.coords.altitude)) ? Math.max(0, Math.min(10000, Math.round(pos.coords.altitude))) : 0;

      statusEl.textContent = `Ubicaci√≥n detectada (${lat}, ${lng}${alt?`, alt ${alt} m`:''}). Obteniendo ciudad y UV‚Ä¶`;

      try {
        // Paso 2: ciudad real (Nominatim)
        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&zoom=10`);
        const geo = await geoRes.json();
        const city = geo?.address?.city || geo?.address?.town || geo?.address?.village || geo?.address?.state || "Ubicaci√≥n";

        // Paso 3: OpenUV (usa lat, lng, alt)
        const uvRes = await fetch(`https://api.openuv.io/api/v1/uv?lat=${lat}&lng=${lng}&alt=${alt}`, {
          method:"GET",
          headers:{ "x-access-token": OPENUV_KEY, "Content-Type":"application/json" }
        });
        if(!uvRes.ok) throw new Error(`OpenUV HTTP ${uvRes.status}`);
        const uvJson = await uvRes.json();

        const uv        = Number(uvJson?.result?.uv ?? 0);
        const uvMax     = Number(uvJson?.result?.uv_max ?? 0);
        const uvTime    = uvJson?.result?.uv_time ? new Date(uvJson.result.uv_time) : null;
        const noonTime  = uvJson?.result?.uv_max_time ? new Date(uvJson.result.uv_max_time) : null;
        const fitz      = uvJson?.result?.safe_exposure_time || null;

        // Render
        renderUV({city, uv, uvMax, uvTime, noonTime, fitz, lat, lng, alt});
        statusEl.textContent = "";
        uvCard.classList.remove("hidden");
      } catch(err){
        console.error(err);
        statusEl.textContent = "‚ùå Error al obtener datos (ciudad o UV). Revisa conectividad y API Key.";
      }
    }

    function onGeoErr(err){
      console.error(err);
      statusEl.textContent = "‚ùå No se pudo acceder a tu ubicaci√≥n (permiso denegado o tiempo agotado).";
    }

    function renderUV({city, uv, uvMax, uvTime, noonTime, fitz, lat, lng, alt}){
      // Encabezado
      cityName.textContent = city;
      uvValue.textContent  = `UV ${uv.toFixed(2)}`;

      // Posici√≥n del indicador (escala 0‚Äì15 ‚Üí 0‚Äì100%)
      const pos = Math.min(uv / 15 * 100, 100);
      uvInd.style.left = `${pos}%`;

      // Nivel + recomendaci√≥n adaptada
      const {levelLabel, color, advice} = uvPolicy(uv);
      uvStatus.innerHTML = `Nivel de exposici√≥n: <strong style="color:${color}">${levelLabel}</strong>`;
      uvAdvice.innerHTML = advice;

      // Tiempos Fitzpatrick si existen
      fitzBox.innerHTML = "";
      if (fitz){
        const rows = [
          ["I", fitz.st1],["II", fitz.st2],["III", fitz.st3],
          ["IV", fitz.st4],["V", fitz.st5],["VI", fitz.st6]
        ].filter(([_,v]) => v!=null);
        if (rows.length){
          const pills = rows.map(([k,v])=>`<span class="pill">Tipo ${k}: ${v} min</span>`).join("");
          fitzBox.innerHTML = `<div style="margin-top:8px">${pills}</div>`;
        }
      }

      // Meta
      const t1 = uvTime ? uvTime.toLocaleTimeString() : "‚Äî";
      const t2 = noonTime ? noonTime.toLocaleTimeString() : "‚Äî";
      uvMeta.innerHTML = `
        <span class="pill">Actualizado: ${t1}</span>
        <span class="pill">UV m√°x hoy: ${uvMax.toFixed(2)} (‚âà ${t2})</span>
        <span class="pill">Altitud usada: ${alt} m</span>
      `;
    }

    // Pol√≠tica de recomendaciones por rango UV (adaptada)
    function uvPolicy(uv){
      let levelLabel, color, advice;
      if (uv <= 2){
        levelLabel = "Bajo ‚òòÔ∏è"; color = "#10b981";
        advice = "Riesgo bajo. Usa SPF 15+, gafas si hay reflejos. Hidr√°tate.";
      } else if (uv <= 5){
        levelLabel = "Moderado üï∂Ô∏è"; color = "#f59e0b";
        advice = "SPF 30+, gorra, gafas UV. Busca sombra entre 12‚Äì14 h si est√°s mucho tiempo fuera.";
      } else if (uv <= 7){
        levelLabel = "Alto üß¥"; color = "#fb923c";
        advice = "SPF 50+, reaplica cada 2 h. Evita exposici√≥n prolongada de 11‚Äì15 h. Ropa de manga larga si es posible.";
      } else if (uv <= 10){
        levelLabel = "Muy alto ‚òÄÔ∏è"; color = "#ef4444";
        advice = "Riesgo alto de da√±o. Evita sol directo 10‚Äì15 h. Ropa UV, sombrero de ala ancha y gafas categor√≠a 3/4.";
      } else {
        levelLabel = "Extremo üî•"; color = "#7c3aed";
        advice = "‚ö†Ô∏è Protecci√≥n m√°xima: SPF 50+ cada 2 h, sombra total 10‚Äì16 h, ropa UV, cuello y orejas cubiertos.";
      }
      return {levelLabel, color, advice};
    }
  </script>
</body>
</html>
