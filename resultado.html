<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SkinGuard ‚Ä¢ Resultados del An√°lisis</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

  <!-- Librer√≠as PDF (dejamos html2canvas por si la usas en otra vista; NO se usa aqu√≠) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      background-color: #f8fafc;
      color: #0f172a;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
    }
    .result-container {
      width: 100%;
      max-width: 950px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      padding: 30px;
      animation: fadeIn 0.6s ease-in-out;
      position: relative;
    }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px);} to { opacity:1; transform: translateY(0);} }
    h1 { text-align: center; font-size: 1.6rem; color: #1e293b; margin-bottom: 24px; }

    /* ‚ùå Bot√≥n de cerrar (volver al dashboard) */
    .close-btn {
      position: absolute; top: 16px; right: 20px;
      background: rgba(15,23,42,0.05); color: #0f172a; border: none; border-radius: 50%;
      width: 34px; height: 34px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: all .2s;
    }
    .close-btn:hover { background: rgba(15,23,42,0.15); transform: scale(1.05); }

    /* üü¢ Resultado principal */
    .main-result { padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 6px solid; }
    .benigno { background-color: #dcfce7; border-color: #22c55e; color: #065f46; }
    .maligno { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
    .main-result h2 { font-size: 1.3rem; margin: 0; }
    .main-result p { margin-top: 8px; color: #334155; }

    /* üìä Secci√≥n inferior */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 10px; }
    .card { background: #f1f5f9; border-radius: 10px; padding: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .card h3 { margin: 0 0 10px; font-size: 1rem; color: #1e3a8a; }
    .details-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    .details-table td { padding: 6px 0; color: #334155; }
    .details-table td:first-child { font-weight: 600; color: #1e293b; }

    /* üí° Recomendaciones */
    .recommendations ul { list-style: none; padding: 0; margin: 0; }
    .recommendations li { margin-bottom: 8px; display: flex; align-items: center; }
    .recommendations li::before { content: "‚úîÔ∏è"; margin-right: 8px; }

    /* ‚ö†Ô∏è Advertencia */
    .warning {
      background: #fffbea; border-left: 6px solid #facc15; padding: 20px; border-radius: 10px; margin-top: 25px;
      color: #92400e; font-size: 0.95rem;
    }

    /* üîò Botones */
    .actions { display: flex; justify-content: center; gap: 16px; margin-top: 25px; flex-wrap: wrap; }
    .btn { padding: 12px 22px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: all .2s; }
    .btn-primary { background: linear-gradient(90deg, #2563eb, #2bb7a6); color: #fff; }
    .btn-primary:hover { background: linear-gradient(90deg, #1e40af, #249c8b); }
    .btn-secondary { background: #f1f5f9; color: #0f172a; }
    .btn-secondary:hover { background: #e2e8f0; }

    /* üß† Imagen + resultado */
    .image-result-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; align-items: start; margin-bottom: 25px; }
    .image-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 10px; }
    .image-card img { width: 100%; border-radius: 8px; object-fit: cover; }

    @media (max-width: 720px) { .image-result-grid { grid-template-columns: 1fr; } .info-grid { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="result-container">
    <!-- ‚ùå Bot√≥n de cierre -->
    <button class="close-btn" onclick="window.location.href='definitivo.html'">‚úñ</button>

    <h1>Resultados del An√°lisis</h1>

    <div class="image-result-grid">
      <!-- üñºÔ∏è Imagen analizada -->
      <div class="image-card">
        <img id="analyzedImage" alt="Imagen analizada" />
      </div>

      <!-- üü¢ Resultado principal -->
      <div id="resultCard" class="main-result benigno">
        <h2 id="resultTitle">‚úÖ Benigno</h2>
        <p id="confidenceText">Confianza: 98.2%</p>
        <p id="resultDesc">
          El an√°lisis indica que la lesi√≥n presenta caracter√≠sticas benignas. 
          No se detectaron signos preocupantes de malignidad.
        </p>
      </div>
    </div>

    <div class="info-grid">
      <!-- üî¨ Detalles t√©cnicos -->
      <div class="card">
        <h3>üìä Detalles del An√°lisis</h3>
        <table class="details-table">
          <tr><td>Modelo utilizado:</td><td>CNN + YOLOv8</td></tr>
          <tr><td>Precisi√≥n del modelo:</td><td>91.06%</td></tr>
          <tr><td>AUC:</td><td>0.9453</td></tr>
          <tr><td>Fecha y hora de an√°lisis:</td><td id="analysisDate">Cargando...</td></tr>
        </table>
      </div>

      <!-- üí° Recomendaciones -->
      <div class="card recommendations">
        <h3>üí° Recomendaciones</h3>
        <ul id="recList">
          <li>Realiza seguimiento fotogr√°fico cada 3 meses.</li>
          <li>Usa protector solar SPF 50+ diariamente.</li>
          <li>Consulta con un dermat√≥logo si observas cambios.</li>
        </ul>
      </div>
    </div>

    <!-- ‚ö†Ô∏è Advertencia -->
    <div class="warning">
      ‚ö†Ô∏è <b>Importante:</b> Este an√°lisis es una herramienta de apoyo preventivo.  
      No sustituye la evaluaci√≥n m√©dica profesional. Consulta con un dermat√≥logo para un diagn√≥stico definitivo.
    </div>

    <!-- üîò Botones -->
    <div class="actions">
      <button class="btn btn-primary">üìÖ Agendar Cita Dermatol√≥gica</button>
      <!-- üîª √öNICO CAMBIO: id para enganchar el PDF nativo -->
      <button class="btn btn-secondary" id="btnPdf">üìÑ Descargar Reporte PDF</button>
    </div>
  </div>

  <script>
    /* ===============================
       DATOS (sin cambios)
    ================================ */
    document.addEventListener("DOMContentLoaded", async () => {
      const userEmail = localStorage.getItem("userEmail");
      if (!userEmail) return;

      const SUPABASE_URL = "https://wstqsqgktlbdefugtpdv.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzdHFzcWdrdGxiZGVmdWd0cGR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODUyNTQsImV4cCI6MjA3NDI2MTI1NH0.ArkLINOc0adJf8bFvf6W-HC-_kGucp15Lyw28ivmc1w";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const { data: user } = await supabase
      .from("usuarios")
      .select("id, nombre, ultimo_resultado, ultima_confianza")
      .eq("email", userEmail)
      .maybeSingle();


      if (!user) return;

      // üîπ Obtener √∫ltimo escaneo con la columna 'fecha'
      const { data: scan } = await supabase
        .from("escaneos")
        .select("fecha")
        .eq("usuario_id", user.id)
        .order("fecha", { ascending: false })
        .limit(1)
        .maybeSingle();

      let analysisDateText = "No registrada";
      if (scan && scan.fecha) {
        const analysisDate = new Date(scan.fecha);
        const localDate = new Date(analysisDate.getTime() - 5 * 60 * 60 * 1000);
        analysisDateText = localDate.toLocaleDateString("es-ES", {
          day: "2-digit", month: "short", year: "numeric",
          hour: "2-digit", minute: "2-digit", second: "2-digit"
        });
      }
      document.getElementById("analysisDate").textContent = analysisDateText;

      // Mostrar resultado
      const result = user.ultimo_resultado || "Benigno";
      const confidence = user.ultima_confianza ? user.ultima_confianza.toFixed(2) : "0.00";
      const resultCard = document.getElementById("resultCard");
      const resultTitle = document.getElementById("resultTitle");
      const confidenceText = document.getElementById("confidenceText");
      const resultDesc = document.getElementById("resultDesc");
      const recList = document.getElementById("recList");

      confidenceText.textContent = `Confianza: ${confidence}%`;

      if (result.toLowerCase() === "maligno") {
        resultCard.classList.replace("benigno", "maligno");
        resultTitle.textContent = "‚ö†Ô∏è Posible Melanoma";
        resultDesc.textContent = "El an√°lisis sugiere caracter√≠sticas compatibles con melanoma, una lesi√≥n potencialmente maligna. Es fundamental realizar una evaluaci√≥n m√©dica prioritaria con un dermat√≥logo especializado para confirmar el diagn√≥stico mediante examen cl√≠nico y biopsia histol√≥gica, ya que la precisi√≥n del diagn√≥stico definitivo solo puede lograrse con an√°lisis m√©dico presencial.";
        recList.innerHTML = `
          <li>Agenda una cita dermatol√≥gica de forma inmediata.</li>
          <li>Evita exposici√≥n solar directa hasta la evaluaci√≥n m√©dica.</li>
          <li>No apliques tratamientos t√≥picos sin indicaci√≥n m√©dica.</li>
          <li>Consulta con un dermat√≥logo certificado para biopsia o an√°lisis complementario.</li>
        `;
      } else {
        resultCard.classList.replace("maligno", "benigno");
        resultTitle.textContent = "‚úÖ Benigno";
        resultDesc.textContent = "El an√°lisis indica que la lesi√≥n presenta caracter√≠sticas benignas y no se detectaron signos preocupantes de malignidad. Seg√∫n los patrones visuales y morfol√≥gicos analizados, la probabilidad de melanoma es muy baja, por lo que no se requiere una intervenci√≥n inmediata. Sin embargo, se recomienda mantener vigilancia preventiva: observe la evoluci√≥n de la lesi√≥n, evite la exposici√≥n solar excesiva y realice autoex√°menes dermatol√≥gicos mensuales siguiendo la regla ABCDE (Asimetr√≠a, Bordes, Color, Di√°metro, Evoluci√≥n).";
        recList.innerHTML = `
          <li>Realiza seguimiento fotogr√°fico cada 3 meses.</li>
          <li>Usa protector solar SPF 50+ diariamente.</li>
          <li>Evita camas de bronceado y exposici√≥n solar prolongada.</li>
          <li>Consulta con un dermat√≥logo si observas cambios en forma, tama√±o o color.</li>
        `;
      }
    });

    // Mostrar imagen analizada (si existe en localStorage)
    const lastImage = localStorage.getItem("lastAnalyzedImage");
    if (lastImage) {
      const analyzedImage = document.getElementById("analyzedImage");
      analyzedImage.src = lastImage;
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ imagen previa en localStorage");
    }

    /* ======================================================
       PDF NATIVO (sin capturas) ‚Äî solo se engancha al #btnPdf
       ====================================================== */
    function textLine(pdf, text, x, y) { pdf.text(text, x, y); return y + 6; }

    async function generarPDFNativo() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  const azulMarino = [30, 58, 138];
  const grisTexto = [51, 65, 85];
  const verde = [34, 197, 94];
  const rojo = [239, 68, 68];
  const grisClaro = [241, 245, 249];

  const pageW = pdf.internal.pageSize.getWidth();
  const margin = 18;
  let y = 20;

  // ================= ENCABEZADO =================
  try {
    // Si tienes un logo, reemplaza el nombre del archivo
    const logoUrl = "logo_skinguard.png";
    const img = await fetch(logoUrl);
    const blob = await img.blob();
    const reader = new FileReader();
    await new Promise(res => { reader.onload = () => res(); reader.readAsDataURL(blob); });
    pdf.addImage(reader.result, "PNG", margin, 10, 22, 22);
  } catch (e) {
    console.warn("No se encontr√≥ logo_skinguard.png");
  }

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(16);
  pdf.setTextColor(azulMarino[0], azulMarino[1], azulMarino[2]);
  pdf.text("INFORME CL√çNICO DE AN√ÅLISIS DERMATOL√ìGICO", pageW / 2, 20, { align: "center" });

  pdf.setFontSize(10);
  pdf.setTextColor(100);
  pdf.text("SkinGuard AI Diagnostic Platform ‚Ä¢ Lima, Per√∫", pageW / 2, 26, { align: "center" });

  y = 38;

  // L√≠nea separadora
  pdf.setDrawColor(azulMarino[0], azulMarino[1], azulMarino[2]);
  pdf.setLineWidth(0.3);
  pdf.line(margin, y, pageW - margin, y);
  y += 8;

  // ================= DATOS DEL PACIENTE =================
  // Traer el nombre guardado previamente en localStorage
  const nombreUsuario = localStorage.getItem("nombreUsuario") || "Usuario";
  const fecha = document.getElementById("analysisDate")?.textContent || "No registrada";

  pdf.setFont("helvetica", "bold");
  pdf.setTextColor(azulMarino[0], azulMarino[1], azulMarino[2]);
  pdf.text("Datos del Paciente", margin, y);
  y += 6;

  pdf.setFont("helvetica", "normal");
  pdf.setTextColor(grisTexto[0], grisTexto[1], grisTexto[2]);
  pdf.setFontSize(11);
  pdf.text(`Paciente: ${nombreUsuario}`, margin, y);
  y += 6;
  pdf.text(`Fecha y hora de an√°lisis: ${fecha}`, margin, y);
  y += 10;


  // ================= RESULTADO PRINCIPAL =================
  const titulo = document.getElementById("resultTitle")?.textContent || "";
  const confianza = document.getElementById("confidenceText")?.textContent || "";
  const maligno = titulo.toLowerCase().includes("melanoma");

  pdf.setDrawColor(...(maligno ? rojo : verde));
  pdf.setFillColor(...(maligno ? [255, 235, 235] : [235, 255, 240]));
  pdf.roundedRect(margin, y, pageW - margin * 2, 25, 3, 3, "FD");

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(13);
  pdf.setTextColor(...(maligno ? rojo : verde));
  pdf.text(titulo, margin + 6, y + 10);

  pdf.setFont("helvetica", "normal");
  pdf.setTextColor(grisTexto[0], grisTexto[1], grisTexto[2]);
  pdf.text(confianza, margin + 6, y + 18);

  y += 35;

  // ================= DETALLES DEL AN√ÅLISIS =================
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(12);
  pdf.setTextColor(azulMarino[0], azulMarino[1], azulMarino[2]);
  pdf.text("Detalles T√©cnicos del Modelo", margin, y);
  y += 6;

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(11);
  pdf.setTextColor(grisTexto[0], grisTexto[1], grisTexto[2]);
  const detalles = [
    "Modelo utilizado: CNN + YOLOv8",
    "Precisi√≥n del modelo: 91.06%",
    "AUC: 0.9453",
    `Fecha y hora de an√°lisis: ${fecha}`,
  ];
  detalles.forEach(t => { pdf.text(t, margin + 2, y); y += 6; });

  y += 4;

  // Imagen si existe
  const imgDataUrl = localStorage.getItem("lastAnalyzedImage");
  if (imgDataUrl) {
    try {
      pdf.addImage(imgDataUrl, "PNG", pageW - margin - 45, y - 20, 40, 40);
    } catch {}
  }
  y += 8;

  // ================= RECOMENDACIONES =================
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(12);
  pdf.setTextColor(azulMarino[0], azulMarino[1], azulMarino[2]);
  pdf.text("Recomendaciones Cl√≠nicas", margin, y);
  y += 6;

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(11);
  pdf.setTextColor(grisTexto[0], grisTexto[1], grisTexto[2]);

  const recs = Array.from(document.querySelectorAll("#recList li")).map(li => li.textContent.trim());
  recs.forEach(r => {
    const texto = pdf.splitTextToSize("‚Ä¢ " + r, pageW - margin * 2);
    pdf.text(texto, margin + 2, y);
    y += texto.length * 5;
  });

  y += 6;

  // ================= ADVERTENCIA =================
  pdf.setDrawColor(250, 204, 21);
  pdf.setFillColor(255, 251, 234);
  pdf.roundedRect(margin, y, pageW - margin * 2, 22, 2, 2, "FD");
  pdf.setTextColor(146, 64, 14);
  pdf.setFont("helvetica", "bold");
  pdf.text("Importante:", margin + 4, y + 7);
  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(10);
  const aviso = "Este informe no sustituye una evaluaci√≥n m√©dica profesional. Se recomienda acudir a un dermat√≥logo certificado para diagn√≥stico definitivo.";
  const avisoTxt = pdf.splitTextToSize(aviso, pageW - margin * 2 - 8);
  pdf.text(avisoTxt, margin + 4, y + 12);
  y += 28;

  // ================= FIRMA Y PIE =================
  pdf.setFont("helvetica", "italic");
  pdf.setFontSize(10);
  pdf.setTextColor(100);
  pdf.text("__________________________________", pageW / 2, y, { align: "center" });
  pdf.text("Revisi√≥n autom√°tica asistida por IA ‚Äì SkinGuard AI", pageW / 2, y + 6, { align: "center" });

  pdf.setFontSize(9);
  pdf.text("SkinGuard 2025 | Plataforma de Diagn√≥stico Dermatol√≥gico Inteligente", pageW / 2, 290, { align: "center" });

  pdf.save(`SkinGuard_Informe_${new Date().toISOString().slice(0, 10)}.pdf`);
}

  // üü¢ Enganchar bot√≥n de descarga PDF
  document.addEventListener("DOMContentLoaded", () => {
    const btnPdf = document.getElementById("btnPdf");
    if (btnPdf) {
      btnPdf.addEventListener("click", () => {
        try {
          generarPDFNativo();
        } catch (e) {
          console.error("Error al generar el PDF:", e);
          alert("‚ö†Ô∏è Ocurri√≥ un error al exportar el reporte. Intenta nuevamente.");
        }
      });
    }
  });

  </script>
</body>
</html>
