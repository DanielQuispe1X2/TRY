<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkinGuard ‚Ä¢ Inicio (Definitivo)</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

  <style>
  .top-cards { 
    display: flex; 
    gap: 16px; 
    margin-bottom: 18px; 
    flex-wrap: wrap; 
  }

  .card { 
    background: #fff; 
    border-radius: 12px; 
    padding: 18px; 
    box-shadow: 0 8px 20px rgba(0,0,0,0.06); 
    flex: 1; 
    min-width: 160px; 
  }

  .card h3 { 
    font-size: 1.6rem; 
    color: #0f172a; 
    margin-bottom: 6px; 
  }

  .card p { 
    color: #64748b; 
    margin: 0; 
  }

  .big-cta { 
    display: flex; 
    gap: 12px; 
    margin: 14px 0; 
  }

  .cta { 
    flex: 1; 
    padding: 18px 20px; 
    border-radius: 12px; 
    color: #fff; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    cursor: pointer; 
  }

  .cta.scan { background: linear-gradient(90deg,#2bb7a6,#2e9ef6); }
  .cta.cita { background: linear-gradient(90deg,#6f6ff0,#a14de8); }

  .activity { margin-top: 18px; }

  .activity .item { 
    background: #fff; 
    padding: 12px; 
    border-radius: 10px; 
    box-shadow: 0 6px 16px rgba(0,0,0,0.06); 
    margin-bottom: 10px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
  }

  .result-benigno { border-left: 5px solid #4ade80; }
  .result-maligno { border-left: 5px solid #f87171; }

  /* üîß CONTENEDOR DE UV + MAPA */
  .uv-map-row { 
    display: flex; 
    gap: 16px; 
    margin-top: 18px; 
    flex-wrap: wrap;
    align-items: stretch;
  }

  .uv-column { 
    flex: 1; 
    min-width: 300px; 
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  .uv-column:last-child {
    display: flex;
    flex-direction: column;
    justify-content: stretch;
  }

  #map { 
    height: 100%;
    min-height: 440px;
    border-radius: 12px; 
    overflow: hidden; 
  }

  #uvCardSmall { 
    padding: 16px; 
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 6px 16px rgba(0,0,0,0.06); 
  }

  #recoCard { 
    padding: 16px; 
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 6px 16px rgba(0,0,0,0.06); 
    margin-top: 14px; 
    display: none; 
  }

  .muted { 
    color: #6b7280; 
    font-size: 0.95rem; 
  }

  @media (max-width: 900px) { 
    .uv-map-row { flex-direction: column; }
    #map { min-height: 320px; }
  }

  /* üîπ MODAL DE CITA */
  .modal-overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4);
    display:none;
    justify-content:center;
    align-items:flex-start;
    padding-top:40px;
    z-index:9999;
  }

  .modal-card {
    background:#fff;
    padding:24px;
    width:380px;
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,0.15);
    max-height:90vh;
    overflow-y:auto;
  }

  .doctorItem {
    padding:14px;
    border-radius:12px;
    border:1px solid #e2e8f0;
    margin-bottom:10px;
    cursor:pointer;
    background:#fff;
    display:flex;
    justify-content:space-between;
    gap:10px;
  }

  .doctorItem-left {
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .doctorItem.selected {
    border-color:#22c55e;
    background:#ecfdf3;
  }

  .doctorPrice {
    color:#059669;
    font-weight:700;
    white-space:nowrap;
  }

  .hour-grid {
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:10px;
    margin-top:8px;
  }

  .hora-btn {
    padding:10px;
    border-radius:8px;
    border:1px solid #cbd5f5;
    background:#f9fafb;
    cursor:pointer;
    font-size:0.95rem;
  }

  .hora-btn.selected {
    background:#2bb7a6;
    color:#fff;
    border-color:#2bb7a6;
  }

  .btn-confirm {
    width:100%;
    padding:14px;
    margin-top:20px;
    background:#e5e7eb;
    color:#9ca3af;
    border:none;
    border-radius:10px;
    font-weight:700;
    cursor:not-allowed;
  }

  .btn-confirm.enabled {
    background:#22c55e;
    color:#fff;
    cursor:pointer;
  }

  .modal-note {
    font-size:0.85rem;
    margin-top:12px;
    padding:10px;
    border-radius:10px;
    background:#eff6ff;
    color:#1d4ed8;
  }
  </style>

</head>
<body>
  
  <div class="container">

    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="logo.png" alt="Logo" style="width:52px;border-radius:10px;">
        <div>
          <h1 style="font-size:1.25rem;margin-bottom:4px;">SkinGuard</h1>
          <div class="muted" id="userGreeting">Cargando usuario...</div>
        </div>
      </div>
      <button id="btnDefLogout" class="btn btn-secondary" style="padding:10px 14px">Cerrar Sesi√≥n</button>
    </div>

    <!-- Top cards -->
    <div class="top-cards">
      <div class="card"><h3 id="countEscaneos">0</h3><p>Escaneos</p></div>
      <div class="card"><h3 id="countCitas">0</h3><p>Citas agendadas</p></div>
      <div class="card"><h3 id="nextCitaText">‚Äî</h3><p>Pr√≥xima cita</p></div>
    </div>

    <!-- UV Banner -->
    <div style="background:#fff3cd;padding:12px;border-radius:10px;border-left:4px solid #f59e0b;margin-bottom:12px;">
      <div id="uvWarningText"><strong>‚òÄÔ∏è √çndice UV:</strong> Consultando...</div>
    </div>

    <!-- CTA buttons -->
    <div class="big-cta">
      <div class="cta scan" id="btnNewScan">
        <div><div style="font-size:1.05rem;">Nuevo Escaneo</div><div style="font-size:.9rem;opacity:.9">Analiza una lesi√≥n cut√°nea</div></div>
        <div style="font-size:22px;">üì∑</div>
      </div>
      <div class="cta cita" id="btnReserve">
        <div><div style="font-size:1.05rem;">Reservar Cita</div><div style="font-size:.9rem;opacity:.9">Selecciona cl√≠nica y doctor</div></div>
        <div style="font-size:22px;">üóìÔ∏è</div>
      </div>
    </div>

    <!-- Actividad reciente -->
    <div class="activity">
      <h3 style="margin-bottom:10px;">Actividad Reciente</h3>
      <div id="recentList"></div>
    </div>

    <!-- üåç Google Maps + UV -->
    <div class="uv-map-row">
      <div class="uv-column">
        <div id="uvCardSmall">
          <h4 style="margin:0 0 8px 0;">√çndice UV en Ubicaci√≥n Seleccionada</h4>
          <div id="uvSmallValue" style="font-size:1.4rem;font-weight:700">‚Äî</div>
          <div id="uvSmallAdvice" class="muted" style="margin-top:8px;">Selecciona una ubicaci√≥n en el mapa</div>
          <div id="uvSmallMeta" class="muted" style="margin-top:8px;">‚Äî</div>
        </div>

        <!-- üß† Tarjeta de Recomendaciones -->
        <div id="recoCard">
          <h4 style="margin-bottom:6px;">üß† Recomendaciones Personalizadas</h4>
          <div id="recoContent" class="muted" style="line-height:1.5;"></div>
        </div>
      </div>

      <div class="uv-column">
        <input id="searchBox" type="text" placeholder="üîç Buscar ubicaci√≥n..." style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #ccc;">
        <div id="map"></div>
      </div>
    </div>

  </div>

  <!-- üìå MODAL RESERVAR CITA -->
  <div id="modalCita" class="modal-overlay">
    <div class="modal-card" id="modalCitaContent">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">Agendar Cita</h2>
        <button id="closeModalCita" style="font-size:20px;border:none;background:transparent;cursor:pointer;">‚úñ</button>
      </div>

      <h3 style="margin:16px 0 8px 0;">Selecciona un Dermat√≥logo</h3>
      <div id="listaDoctores"></div>

      <h3 style="margin-top:18px;">Fecha</h3>
      <input type="date" id="citaFecha" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;">

      <h3 style="margin-top:18px;">Horario</h3>
      <div id="horasContainer" class="hour-grid">
        <button class="hora-btn">09:00</button>
        <button class="hora-btn">10:00</button>
        <button class="hora-btn">11:00</button>
        <button class="hora-btn">14:00</button>
        <button class="hora-btn">15:00</button>
        <button class="hora-btn">16:00</button>
      </div>

      <div class="modal-note">
        Comisi√≥n SkinGuard: Como parte de nuestra red de cl√≠nicas asociadas, aplicamos una comisi√≥n del 12% por gesti√≥n de cita.
      </div>

      <button id="btnConfirmarCita" class="btn-confirm" disabled>Confirmar Cita</button>
    </div>
  </div>

  <script>
    /***** CONFIGURACI√ìN *****/
    const SUPABASE_URL = "https://wstqsqgktlbdefugtpdv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzdHFzcWdrdGxiZGVmdWd0cGR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODUyNTQsImV4cCI6MjA3NDI2MTI1NH0.ArkLINOc0adJf8bFvf6W-HC-_kGucp15Lyw28ivmc1w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /***** FLUJO PRINCIPAL *****/
    let user = null;
    let selectedHora = null;

    (async function init(){
      if (localStorage.getItem("isLoggedIn") !== "true") {
        window.location.href = "login.html"; return;
      }

      const userEmail = localStorage.getItem("userEmail");
      document.getElementById("userGreeting").textContent = userEmail;

      const { data } = await supabase.from("usuarios").select("*").eq("email", userEmail).maybeSingle();
      user = data;
      if (!user) { alert("Usuario no encontrado"); return; }

      document.getElementById("countEscaneos").textContent = user.numero_escaneos ?? 0;
      document.getElementById("countCitas").textContent = user.numero_citas ?? 0;
      document.getElementById("nextCitaText").textContent = "A√∫n no has agendado una cita";

      await cargarUltimosRegistros(user.id, user.ultimo_resultado, user.ultima_confianza);
      await cargarProximaCita(user.id);
      consultarUVLocal();

      document.getElementById("btnNewScan").addEventListener("click", () => window.location.href = "escaneo.html");
      document.getElementById("btnReserve").addEventListener("click", abrirModalCita);
      document.getElementById("btnDefLogout").addEventListener("click", () => { localStorage.clear(); window.location.href="login.html"; });

      // listeners del modal
      document.getElementById("closeModalCita").addEventListener("click", cerrarModalCita);
      document.getElementById("modalCita").addEventListener("click", (e)=>{
        if(e.target.id === "modalCita") cerrarModalCita();
      });
      document.getElementById("citaFecha").addEventListener("change", checkConfirmReady);
      
      // üî• Bloquear fechas pasadas (GMT-5 no afecta aqu√≠)
      document.getElementById("citaFecha").setAttribute("min", new Date().toISOString().split("T")[0]);
      
      // horas
      document.querySelectorAll(".hora-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".hora-btn").forEach(b=>b.classList.remove("selected"));
          btn.classList.add("selected");
          selectedHora = btn.textContent;
          checkConfirmReady();
        });
      });

      document.getElementById("btnConfirmarCita").addEventListener("click", confirmarCita);
    })();

    /***** ESCANEOS Y ACTIVIDAD *****/
    async function cargarUltimosRegistros(userId, ultimoResultado, ultimaConfianza){
      const { data: escaneo } = await supabase
        .from("escaneos")
        .select("*")
        .eq("usuario_id", userId)
        .order("fecha", { ascending: false })
        .limit(1)
        .maybeSingle();

      const recent = document.getElementById("recentList");
      recent.innerHTML = "";

      const resultado = escaneo?.resultado || ultimoResultado || "Sin datos";
      let confianza = escaneo?.confianza || ultimaConfianza || 0;
      const esMaligno = resultado.toLowerCase() === "maligno";
      if (!esMaligno) confianza = 100 - confianza;

      let fecha;
      if (escaneo?.fecha) {
        const utcDate = new Date(escaneo.fecha);
        const localDate = new Date(utcDate.getTime() - (5 * 60 * 60 * 1000));
        fecha = localDate.toLocaleString("es-PE", { dateStyle: "short", timeStyle: "short", hour12: false });
      } else fecha = "Fecha no disponible";

      const icono = esMaligno ? "‚ö†Ô∏è" : "‚úÖ";
      const clase = esMaligno ? "result-maligno" : "result-benigno";

      recent.innerHTML += `
        <div class="item ${clase}">
          <div>
            <strong>√öltimo Escaneo:</strong> ${icono} ${resultado}<br>
            <span class="muted">Confianza: ${parseFloat(confianza).toFixed(2)}%</span><br>
            <span class="muted">Fecha: ${fecha}</span>
          </div>
        </div>
      `;

      mostrarRecomendaciones(resultado, confianza);
    }

    /***** Pr√≥xima cita desde Supabase *****/
    async function cargarProximaCita(userId){
      try{
        const { data: cita, error } = await supabase
          .from("citas")
          .select("fecha,hora, doctores(nombre)")
          .eq("usuario_id", userId)
          .order("fecha", { ascending:true })
          .order("hora", { ascending:true })
          .limit(1)
          .maybeSingle();

        if(!error && cita){
          // üî• Correcci√≥n para evitar desfase de un d√≠a
          const [year, month, day] = cita.fecha.split("-");
          const fechaObj = new Date(year, month - 1, day);
          
          const fechaStr = fechaObj.toLocaleDateString("es-PE");
          document.getElementById("nextCitaText").textContent =
            `${fechaStr} ‚Ä¢ ${cita.hora.slice(0,5)} con ${cita.doctores?.nombre || "dermat√≥logo"}`;
        }

        const { count } = await supabase
          .from("citas")
          .select("id", { count: "exact", head: true })
          .eq("usuario_id", userId);

        if(typeof count === "number"){
          document.getElementById("countCitas").textContent = count;
        }
      }catch(e){
        console.warn("No se pudo cargar pr√≥xima cita", e);
      }
    }

    /***** üß† Recomendaciones seg√∫n resultado *****/
    function mostrarRecomendaciones(ultimoResultado, ultimaConfianza) {
      const card = document.getElementById("recoCard");
      const content = document.getElementById("recoContent");
      if (!ultimoResultado || ultimaConfianza == null) {
        card.style.display = "none";
        return;
      }

      const confianza = parseFloat(ultimaConfianza);
      let mensaje = "";
      let colorFondo = "#fff";

      if (ultimoResultado.toLowerCase() === "benigno") {
        colorFondo = "#e8f5e9";
        mensaje = `
          üåø <b>Resultado Benigno</b> (Conf. ${confianza.toFixed(1)}%)<br>
          ¬°Excelente! Tu piel no presenta se√±ales de riesgo. üòå<br>
          Mant√©n tus revisiones mensuales y usa protector solar SPF 30+ al salir ‚òÄÔ∏è.<br><br>
        `;
        if (confianza > 90) mensaje += "‚úÖ Tu resultado es muy confiable. Contin√∫a con tus cuidados habituales.";
        else if (confianza >= 70) mensaje += "üîÅ Todo parece bien, pero repite un escaneo en unos d√≠as por seguridad.";
        else mensaje += "‚ö†Ô∏è El resultado es benigno, aunque con baja confianza. Te sugerimos repetir el escaneo con mejor iluminaci√≥n.";
      } 
      else if (ultimoResultado.toLowerCase() === "maligno") {
        colorFondo = "#fee2e2";
        mensaje = `
          üö® <b>Resultado Maligno</b> (Conf. ${confianza.toFixed(1)}%)<br>
          Nuestra IA detecta signos de posible riesgo. ü©∫<br>
          Agenda una cita dermatol√≥gica lo antes posible y evita exposici√≥n solar directa. üëï<br><br>
        `;
        if (confianza > 90) mensaje += "‚ö†Ô∏è Probabilidad alta: acude a revisi√≥n m√©dica prioritaria.";
        else if (confianza >= 70) mensaje += "ü©∫ Puede existir riesgo: repite el escaneo y consulta a un especialista.";
        else mensaje += "üîé Resultado incierto: realiza un nuevo an√°lisis con buena iluminaci√≥n.";
      }

      card.style.display = "block";
      card.style.background = colorFondo;
      content.innerHTML = mensaje;
    }

    /***** MODAL DE CITA *****/
    async function abrirModalCita(){
      const modal = document.getElementById("modalCita");
      const lista = document.getElementById("listaDoctores");
      lista.innerHTML = "Cargando doctores...";

      modal.style.display = "flex";

      const { data: doctores, error } = await supabase
        .from("doctores")
        .select("id,nombre,especialidad,tarifa,clinica_id, clinicas(nombre)");

      if(error){
        lista.innerHTML = "No se pudieron cargar los doctores.";
        console.error(error);
        return;
      }

      lista.innerHTML = "";
      doctores.forEach(doc=>{
        const tarifaTexto = doc.tarifa != null ? `S/.${doc.tarifa}` : "S/.--";
        lista.innerHTML += `
          <div class="doctorItem" 
               data-id="${doc.id}" 
               data-clinica="${doc.clinica_id}" 
               data-tarifa="${doc.tarifa || 0}"
               data-nombre="${doc.nombre}">
            <div class="doctorItem-left">
              <strong>${doc.nombre}</strong>
              <span class="muted">${doc.especialidad}</span>
              <span class="muted">${doc.clinicas?.nombre || ""}</span>
            </div>
            <div class="doctorPrice">${tarifaTexto}</div>
          </div>
        `;
      });

      // listeners de selecci√≥n de doctor
      document.querySelectorAll(".doctorItem").forEach(item=>{
        item.addEventListener("click", ()=>{
          document.querySelectorAll(".doctorItem").forEach(x=>x.classList.remove("selected"));
          item.classList.add("selected");
          checkConfirmReady();
        });
      });
    }

    function cerrarModalCita(){
      document.getElementById("modalCita").style.display = "none";
      document.getElementById("btnConfirmarCita").disabled = true;
      document.getElementById("btnConfirmarCita").classList.remove("enabled");
      document.getElementById("citaFecha").value = "";
      selectedHora = null;
      document.querySelectorAll(".hora-btn").forEach(b=>b.classList.remove("selected"));
    }

    function checkConfirmReady(){
      const doctorSel = document.querySelector(".doctorItem.selected");
      const fecha = document.getElementById("citaFecha").value;
      const btn = document.getElementById("btnConfirmarCita");

      if(doctorSel && fecha && selectedHora){
        btn.disabled = false;
        btn.classList.add("enabled");
      }else{
        btn.disabled = true;
        btn.classList.remove("enabled");
      }
    }

    async function confirmarCita(){
      const doctorDiv = document.querySelector(".doctorItem.selected");
      const fecha = document.getElementById("citaFecha").value;
      if(!doctorDiv || !fecha || !selectedHora) return;

      const doctorId = doctorDiv.dataset.id;
      const clinicaId = doctorDiv.dataset.clinica;
      const doctorNombre = doctorDiv.dataset.nombre;
      const tarifa = Number(doctorDiv.dataset.tarifa || 0);
      const limaTime = new Date(new Date().getTime() - 5 * 60 * 60 * 1000).toISOString();

      const { error } = await supabase.from("citas").insert({
        usuario_id: user.id,
        doctor_id: doctorId,
        clinica_id: clinicaId,
        fecha: fecha,
        hora: selectedHora,
        estado: "pendiente",
        created_at: limaTime
      });

      if(error){
        alert("Ocurri√≥ un error al registrar la cita.");
        console.error(error);
        return;
      }

      // actualizar m√©tricas en dashboard
      await cargarProximaCita(user.id);

      // vista de confirmaci√≥n sencilla
      // ‚úÖ Correcci√≥n definitiva para evitar desfase de un d√≠a
      const [y, m, d] = fecha.split("-");
      const fechaObj = new Date(Number(y), Number(m) - 1, Number(d));
      const fechaTexto = fechaObj.toLocaleDateString("es-PE");

      const modalContent = document.getElementById("modalCitaContent");
      modalContent.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 style="margin:0;">Agendar Cita</h2>
          <button id="closeModalCitaConfirm" style="font-size:20px;border:none;background:transparent;cursor:pointer;">‚úñ</button>
        </div>
        <div style="text-align:center;padding:30px 10px 10px;">
          <div style="width:70px;height:70px;border-radius:999px;background:#dcfce7;margin:0 auto 18px;display:flex;align-items:center;justify-content:center;font-size:34px;">‚úî</div>
          <h3 style="margin-bottom:8px;">¬°Cita Confirmada!</h3>
          <p class="muted">Tu cita con <b>${doctorNombre}</b> ha sido agendada<br>
          para el <b>${fechaTexto}</b> a las <b>${selectedHora}</b>.</p>
          <p class="muted" style="margin-top:12px;">Recibir√°s un recordatorio 24 horas antes.</p>
          <button id="btnCerrarConfirm" class="btn-confirm enabled" style="margin-top:24px;">Cerrar</button>
        </div>
      `;

      document.getElementById("closeModalCitaConfirm").onclick = cerrarModalCita;
      document.getElementById("btnCerrarConfirm").onclick = cerrarModalCita;
    }

    /***** √çNDICE UV *****/
    function uvAdviceText(uv) {
      if (uv <= 2) return { title:"Bajo", short:"‚òòÔ∏è Riesgo m√≠nimo", long:"Puedes disfrutar al aire libre con tranquilidad. Usa protector solar SPF 15+ si permanecer√°s mucho tiempo al sol. üëí", color:"#00c851", icon:"‚òòÔ∏è" };
      if (uv <= 5) return { title:"Moderado", short:"üï∂Ô∏è Riesgo moderado", long:"Usa SPF 30+, gorra y gafas UV. Evita exposici√≥n 11‚Äì15h. üß¢üï∂Ô∏è", color:"#fbbf24", icon:"üï∂Ô∏è" };
      if (uv <= 7) return { title:"Alto", short:"üß¥ Riesgo alto", long:"Usa SPF 50+, ropa ligera y sombra. Evita sol directo m√°s de 30 min. ‚òÄÔ∏è", color:"#fb923c", icon:"üß¥" };
      if (uv <= 10) return { title:"Muy alto", short:"‚òÄÔ∏è Muy alto", long:"Quemaduras en <15 min. Evita actividades al sol. SPF 50+ y ropa UV. ‚ö†Ô∏èüíß", color:"#f87171", icon:"‚òÄÔ∏è" };
      return { title:"Extremo", short:"üî• Extremo", long:"Evita sol directo. Usa protecci√≥n total: SPF 50+, sombrero y gafas UV. üö´üåû", color:"#8b5cf6", icon:"üî•" };
    }

    async function consultarUVLocal(){
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        try {
          const { latitude, longitude } = pos.coords;
          await consultarClimaGoogle(latitude, longitude);
        } catch(e){
          document.getElementById("uvWarningText").textContent = "Error al consultar √≠ndice UV.";
        }
      });
    }

    /***** GOOGLE MAPS + GOOGLE WEATHER API *****/
    let map, marker, autocomplete, currentCircle;
    function initMap() {
      const peruCenter = { lat: -9.19, lng: -75.0152 };
      map = new google.maps.Map(document.getElementById("map"), { center: peruCenter, zoom: 6 });

      const input = document.getElementById("searchBox");
      autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo("bounds", map);

      marker = new google.maps.Marker({ map, draggable: true, visible: false });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude, longitude } = pos.coords;
          const position = { lat: latitude, lng: longitude };
          map.setCenter(position);
          map.setZoom(11);
          currentCircle = new google.maps.Circle({
            strokeColor: "#1E90FF", strokeOpacity: 0.8, strokeWeight: 2,
            fillColor: "#1E90FF", fillOpacity: 0.3, map, center: position, radius: 300,
          });
          new google.maps.Marker({
            position, map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: "#1E90FF", fillOpacity: 1, strokeWeight: 2, strokeColor: "#fff" },
          });
          await consultarClimaGoogle(latitude, longitude);
        });
      }

      autocomplete.addListener("place_changed", async () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;
        map.setCenter(place.geometry.location);
        map.setZoom(10);
        marker.setPosition(place.geometry.location);
        marker.setVisible(true);
        await consultarClimaGoogle(place.geometry.location.lat(), place.geometry.location.lng());
      });

      map.addListener("click", async (event) => {
        const lat = event.latLng.lat();
        const lng = event.latLng.lng();
        marker.setPosition(event.latLng);
        marker.setVisible(true);
        map.panTo(event.latLng);
        await consultarClimaGoogle(lat, lng);
      });
    }

    async function consultarClimaGoogle(lat, lng) {
      const API_KEY = "AIzaSyBlwIdORlP_f6EAr1L_bpMBaIylsNmHUqE";
      const url = `https://weather.googleapis.com/v1/currentConditions:lookup?key=${API_KEY}&location.latitude=${lat}&location.longitude=${lng}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const clima = data?.weatherCondition?.description?.text || "Sin datos";
        const temperatura = data?.temperature?.degrees ?? 0;
        const humedad = data?.relativeHumidity ?? 0;
        const uv = data?.uvIndex ?? 0;
        const hora = data?.currentTime ? new Date(data.currentTime).toLocaleTimeString("es-PE") : "‚Äî";
        const adv = uvAdviceText(uv);
        document.getElementById("uvSmallValue").textContent = `UV ${uv}`;
        document.getElementById("uvSmallAdvice").innerHTML = `<b>${adv.icon} ${adv.title}</b> ‚Äî ${adv.short}<br>üå°Ô∏è ${temperatura.toFixed(1)} ¬∞C ‚Ä¢ üíß ${humedad}%<br>‚òÅÔ∏è ${clima}`;
        document.getElementById("uvSmallMeta").textContent = `Actualizado: ${hora}`;
        document.getElementById("uvWarningText").innerHTML = `<strong>${adv.icon} Nivel ${adv.title} (${uv}):</strong> ${adv.long}`;
      } catch (err) {
        console.error("Error al obtener clima:", err);
        document.getElementById("uvSmallAdvice").textContent = "No se pudo obtener datos del clima.";
      }
    }
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNwqvdDAk95m-k2d-lW7e3Gd0j28AzYU0&libraries=places&callback=initMap"></script>
</body>
</html>
